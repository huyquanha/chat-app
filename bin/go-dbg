#!/usr/bin/env bash

set -euo pipefail

target=$1

rule_type=$(bazel query --output=label_kind "${target}" | awk '{print $1}')
if [[ "${rule_type}" != "go_binary" ]]; then
  echo "error: target must be a go_binary, got ${rule_type}" >&2
  exit 1
fi

bazel build -c dbg "${target}"

out=$(bazel cquery -c dbg --output=files "${target}")

# dlv exec will pause the process execution until the debugger attaches.
# :0 to let the OS assign a random (and free) port.
dlv exec "${out}" --log --log-output=dap --headless --listen=127.0.0.1:0 --api-version=2