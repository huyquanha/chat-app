#!/usr/bin/env bash

set -euo pipefail

workspace=$(git rev-parse --show-toplevel)

file=$1

# Convert file path to bazel label path (remove leading workspace prefix)
rel=${file#"${workspace}/"}

if [[ "${rel}" == *_test.go ]]; then
  rule_type="go_test"
else
  rule_type="go_binary"
fi

# Filter to the right rule type
target=$(bazel query "kind(${rule_type}, rdeps(//..., ${rel}))" | head -1)

if [[ -z "${target}" ]]; then
  echo "error: could not find ${rule_type} target that contains ${file}" >&2
  exit 1
fi

echo "found target: ${target}"

bazel build -c dbg "${target}"

out=$(bazel cquery -c dbg --output=files "${target}")

# Add --log --log-output=dap to see more detailed debug logs.
dlv exec "${out}" --headless --listen=127.0.0.1:2345 --api-version=2